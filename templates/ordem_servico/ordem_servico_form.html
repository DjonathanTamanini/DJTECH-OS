{% extends 'base.html' %}

{% block title %}{{ titulo }} - DJTECH-OS{% endblock %}

{% block page_title %}{{ titulo }}{% endblock %}
{% block page_subtitle %}
    {% if ordem %}Editar ordem de serviço{% else %}Criar nova ordem de serviço{% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <form method="post" novalidate id="osForm">
            {% csrf_token %}
            
            <div class="card mb-3 border-primary shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person"></i> Identificação do Cliente</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Cliente *</label>
                            
                            <div class="input-group mb-2" id="campo-busca-cliente" {% if ordem %}style="display: none;"{% endif %}>
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="busca-cliente" class="form-control" placeholder="Digite nome ou CPF/CNPJ do cliente..." autocomplete="off">
                            </div>
                            
                            <div id="resultados-busca" class="list-group mb-2 shadow" style="display: none; position: absolute; z-index: 1000; width: 95%;"></div>
                            
                            <div id="cliente-selecionado" {% if not ordem %}style="display: none;"{% endif %}>
                                <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                                    <div>
                                        <h5 id="cliente-nome" class="mb-1">{% if ordem %}{{ ordem.cliente.nome }}{% endif %}</h5>
                                        <small id="cliente-info" class="text-muted">{% if ordem %}{{ ordem.cliente.cpf_cnpj }}{% endif %}</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="limpar-cliente">
                                        <i class="bi bi-arrow-left-right"></i> Trocar Cliente
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="cliente" id="id_cliente" required value="{% if ordem %}{{ ordem.cliente.id }}{% endif %}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-laptop"></i> Equipamento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Tipo de Equipamento *</label>
                            {{ form.tipo_equipamento }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Marca *</label>
                            {{ form.marca }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Modelo *</label>
                            {{ form.modelo }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Nº de Série / IMEI</label>
                            {{ form.numero_serie }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> Situação Técnica</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold text-danger">Defeito Relatado pelo Cliente *</label>
                            {{ form.defeito_relatado }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold text-primary">Diagnóstico Técnico (Defeito Encontrado)</label>
                            {{ form.defeito_encontrado }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Status da Ordem *</label>
                            {{ form.status }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Técnico Responsável</label>
                            {{ form.tecnico }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Previsão de Entrega</label>
                            {{ form.prazo_estimado }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 border-info shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center py-2">
                    <h6 class="mb-0"><i class="bi bi-box-seam"></i> Peças e Insumos Utilizados</h6>
                    <button type="button" class="btn btn-light btn-sm fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalBuscaPeca">
                        <i class="bi bi-search"></i> BUSCAR NO ESTOQUE
                    </button>
                </div>
                <div class="card-body p-0">
                    {{ formset.management_form }}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 45%; padding-left: 15px;">Item</th>
                                    <th style="width: 15%;">Quantidade</th>
                                    <th style="width: 20%;">Vlr. Unitário (R$)</th>
                                    <th style="width: 15%;">Subtotal</th>
                                    <th style="width: 5%; text-align: center;">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="pecas-formset">
                                {% for form_peca in formset %}
                                    <tr class="peca-form">
                                        {{ form_peca.id }}
                                        <td class="ps-3">
                                            {{ form_peca.peca }}
                                        </td>
                                        <td>
                                            {{ form_peca.quantidade }}
                                        </td>
                                        <td>
                                            {{ form_peca.valor_unitario }}
                                        </td>
                                        <td>
                                            <span class="fw-bold text-muted small peca-subtotal">R$ 0,00</span>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check d-inline-block">
                                                {{ form_peca.DELETE }}
                                                <label class="form-check-label text-danger" for="{{ form_peca.DELETE.id_for_label }}">
                                                    <i class="bi bi-trash"></i>
                                                </label>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 bg-light border-top">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="add-peca">
                            <i class="bi bi-plus-lg"></i> Adicionar Linha Manual
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm border-dark">
                <div class="card-header bg-dark text-white py-2">
                    <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Fechamento Financeiro</h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Mão de Obra (R$)</label>
                            {{ form.valor_mao_obra }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Total Peças (R$)</label>
                            {{ form.valor_pecas }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label text-danger">Desconto (R$)</label>
                            {{ form.desconto }}
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-success border-success mb-0 py-2 text-center">
                                <small class="d-block text-uppercase fw-bold">Valor Total da OS</small>
                                <h3 class="mb-0" id="valor-total-exibicao">R$ 0,00</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-5 bg-transparent border-0">
                <div class="card-body p-0 d-flex justify-content-between">
                    <a href="{% url 'ordem_servico_lista' %}" class="btn btn-secondary btn-lg shadow">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg shadow px-5">
                        <i class="bi bi-check-circle"></i> SALVAR ORDEM DE SERVIÇO
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalBuscaPeca" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-search"></i> Pesquisar Item no Estoque</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="inputBuscaModal" class="form-control" placeholder="Procure por nome, código ou part number...">
                    <button class="btn btn-info text-white" type="button" id="btnFazerBusca">Buscar</button>
                </div>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>Saldo</th>
                                <th>Venda</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="listaResultadosPecas">
                            <tr><td colspan="5" class="text-center text-muted py-4">Utilize o campo de busca acima</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. BUSCA DINÂMICA DE CLIENTE
    const inputBuscaCli = document.getElementById('busca-cliente');
    const resBuscaCli = document.getElementById('resultados-busca');
    const cliSelArea = document.getElementById('cliente-selecionado');
    const inputCliId = document.getElementById('id_cliente');

    if (inputBuscaCli) {
        inputBuscaCli.addEventListener('input', function() {
            const termo = this.value;
            if (termo.length < 2) { resBuscaCli.style.display = 'none'; return; }
            
            fetch(`/ordem-servico/buscar-clientes/?termo=${encodeURIComponent(termo)}`)
                .then(r => r.json())
                .then(data => {
                    resBuscaCli.innerHTML = '';
                    data.clientes.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = 'list-group-item list-group-item-action py-2';
                        btn.innerHTML = `<strong>${c.nome}</strong> <small class="text-muted">(${c.cpf_cnpj})</small>`;
                        btn.onclick = (e) => {
                            e.preventDefault();
                            inputCliId.value = c.id;
                            document.getElementById('cliente-nome').innerText = c.nome;
                            document.getElementById('cliente-info').innerText = c.cpf_cnpj;
                            cliSelArea.style.display = 'block';
                            document.getElementById('campo-busca-cliente').style.display = 'none';
                            resBuscaCli.style.display = 'none';
                        };
                        resBuscaCli.appendChild(btn);
                    });
                    resBuscaCli.style.display = 'block';
                });
        });
    }

    document.getElementById('limpar-cliente').onclick = () => {
        inputCliId.value = '';
        cliSelArea.style.display = 'none';
        document.getElementById('campo-busca-cliente').style.display = 'flex';
        inputBuscaCli.value = '';
        inputBuscaCli.focus();
    };

    // 2. BUSCA DE PEÇAS NO MODAL
    const inputPecaModal = document.getElementById('inputBuscaModal');
    const btnBuscaPeca = document.getElementById('btnFazerBusca');
    const listaPecas = document.getElementById('listaResultadosPecas');

    const acaoBuscaPeca = () => {
        const q = inputPecaModal.value;
        if(q.length < 2) return;
        listaPecas.innerHTML = '<tr><td colspan="5" class="text-center">Pesquisando...</td></tr>';
        
        fetch(`/ordem-servico/api/buscar-pecas-json/?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                listaPecas.innerHTML = '';
                if(data.length === 0) {
                    listaPecas.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Nenhum item encontrado.</td></tr>';
                    return;
                }
                data.forEach(p => {
                    listaPecas.innerHTML += `
                        <tr>
                            <td><small class="badge bg-light text-dark">${p.codigo}</small></td>
                            <td>${p.nome}</td>
                            <td>${p.estoque} un</td>
                            <td class="fw-bold">R$ ${p.preco}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-success" 
                                    onclick="vincularPeca('${p.id}', '${p.preco}')">Inserir</button>
                            </td>
                        </tr>`;
                });
            });
    };

    btnBuscaPeca.onclick = acaoBuscaPeca;
    inputPecaModal.onkeyup = (e) => { if(e.key === 'Enter') acaoBuscaPeca(); };

    window.vincularPeca = (id, preco) => {
        const rows = document.querySelectorAll('.peca-form');
        let preenchido = false;
        
        for (let row of rows) {
            let select = row.querySelector('select[name$="-peca"]');
            if (select && !select.value) {
                select.value = id;
                row.querySelector('input[name$="-valor_unitario"]').value = preco.replace('.',',');
                row.querySelector('input[name$="-quantidade"]').value = 1;
                preenchido = true; break;
            }
        }

        if (!preenchido) {
            document.getElementById('add-peca').click();
            setTimeout(() => vincularPeca(id, preco), 150);
            return;
        }

        bootstrap.Modal.getInstance(document.getElementById('modalBuscaPeca')).hide();
        atualizarTotalGeral();
    };

    // 3. CÁLCULOS FINANCEIROS
    function atualizarTotalGeral() {
        let totalPecas = 0;
        
        // Calcula cada linha da tabela
        document.querySelectorAll('.peca-form').forEach(row => {
            const isDelete = row.querySelector('input[name$="-DELETE"]')?.checked;
            if (!isDelete) {
                const qtd = parseFloat(row.querySelector('input[name$="-quantidade"]').value) || 0;
                const vlr = parseFloat(row.querySelector('input[name$="-valor_unitario"]').value.replace(',','.')) || 0;
                const sub = qtd * vlr;
                row.querySelector('.peca-subtotal').innerText = `R$ ${sub.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                totalPecas += sub;
            }
        });

        // Atualiza campos de resumo
        const inputValorPecas = document.querySelector('input[name="valor_pecas"]');
        if(inputValorPecas) inputValorPecas.value = totalPecas.toFixed(2).replace('.',',');

        const maoObra = parseFloat(document.querySelector('input[name="valor_mao_obra"]').value.replace(',','.')) || 0;
        const desconto = parseFloat(document.querySelector('input[name="desconto"]').value.replace(',','.')) || 0;
        
        const totalFinal = (maoObra + totalPecas) - desconto;
        document.getElementById('valor-total-exibicao').innerText = `R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    }

    // Eventos para recalcular
    document.getElementById('osForm').addEventListener('input', (e) => {
        if (e.target.matches('input')) atualizarTotalGeral();
    });

    // 4. LÓGICA DO FORMSET (ADICIONAR LINHA)
    let totalForms = document.getElementById('id_pecas_utilizadas-TOTAL_FORMS');
    document.getElementById('add-peca').onclick = () => {
        let count = parseInt(totalForms.value);
        let firstRow = document.querySelector('.peca-form');
        let newRow = firstRow.cloneNode(true);
        
        newRow.innerHTML = newRow.innerHTML.replace(/pecas_utilizadas-(\d+)-/g, `pecas_utilizadas-${count}-`);
        newRow.querySelectorAll('input, select').forEach(i => {
            if(i.type === 'checkbox') i.checked = false;
            else i.value = '';
        });
        newRow.querySelector('.peca-subtotal').innerText = 'R$ 0,00';
        
        document.getElementById('pecas-formset').appendChild(newRow);
        totalForms.value = count + 1;
    };

    // Inicialização
    atualizarTotalGeral();
});
</script>
{% endblock %}
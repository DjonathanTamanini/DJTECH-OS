{% extends 'base.html' %}
{% load static %}

{% block title %}Detalhes da OS #{{ ordem.pk }}{% endblock %}

{% block page_title %}OS #{{ ordem.pk }}{% endblock %}
{% block page_subtitle %}Visualização completa e histórico{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'ordem_servico_lista' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
        <div class="d-flex gap-2">
            {% if ordem.cliente.telefone_principal %}
            <a href="https://wa.me/55{{ ordem.cliente.telefone_principal|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Olá {{ ordem.cliente.nome }}, referente a OS {{ ordem.pk }}..." 
               target="_blank" class="btn btn-success text-white">
                <i class="bi bi-whatsapp"></i> WhatsApp
            </a>
            {% endif %}

            <a href="{% url 'ordem_servico_imprimir' ordem.pk %}" target="_blank" class="btn btn-secondary">
                <i class="bi bi-printer"></i> Imprimir
            </a>

            <a href="{% url 'ordem_servico_editar' ordem.pk %}" class="btn btn-primary px-4">
                <i class="bi bi-pencil-square"></i> Editar OS
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            
            <div class="card shadow-sm mb-4 border-top border-4 {% if ordem.status == 'pronto' %}border-success{% elif ordem.status == 'cancelado' %}border-danger{% else %}border-primary{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge rounded-pill bg-light text-dark border mb-2">Entrada: {{ ordem.data_entrada|date:"d/m/Y H:i" }}</span>
                            <h4 class="card-title mb-0">{{ ordem.tipo_equipamento }} {{ ordem.marca }}</h4>
                            <p class="text-muted">{{ ordem.modelo }} <small class="ms-2">S/N: {{ ordem.numero_serie|default:"Não informado" }}</small></p>
                        </div>
                        <div class="text-end">
                            {% if ordem.status == 'recepcao' %}
                                <span class="badge bg-secondary fs-6">Recepção</span>
                            {% elif ordem.status == 'analise' %}
                                <span class="badge bg-info text-dark fs-6">Em Análise</span>
                            {% elif ordem.status == 'aprovacao' %}
                                <span class="badge bg-warning text-dark fs-6">Aguardando Aprovação</span>
                            {% elif ordem.status == 'reparo' %}
                                <span class="badge bg-primary fs-6">Em Reparo</span>
                            {% elif ordem.status == 'pronto' %}
                                <span class="badge bg-success fs-6">Pronto</span>
                            {% elif ordem.status == 'entregue' %}
                                <span class="badge bg-dark fs-6">Entregue</span>
                            {% elif ordem.status == 'cancelado' %}
                                <span class="badge bg-danger fs-6">Cancelado</span>
                            {% endif %}
                            
                            {% if ordem.esta_atrasada %}
                                <div class="mt-2 text-danger fw-bold small"><i class="bi bi-exclamation-triangle"></i> ATRASADO</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="alert alert-light border border-secondary border-opacity-25 rounded-3">
                        <strong class="text-secondary"><i class="bi bi-person-fill-exclamation"></i> Relato do Cliente:</strong>
                        <p class="mb-0 mt-1">{{ ordem.defeito_cliente|linebreaksbr }}</p>
                    </div>

                    {% if ordem.diagnostico_tecnico %}
                    <div class="alert alert-info border-0 rounded-3 mt-3">
                        <strong class="text-info-emphasis"><i class="bi bi-tools"></i> Diagnóstico Técnico:</strong>
                        <p class="mb-0 mt-1">{{ ordem.diagnostico_tecnico|linebreaksbr }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-secondary"><i class="bi bi-grid-3x3"></i> Peças e Materiais</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Item</th>
                                    <th>Qtd</th>
                                    <th>Valor Unit.</th>
                                    <th class="text-end pe-4">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordem.pecas.all %}
                                <tr>
                                    <td class="ps-4">{{ item.peca.nome }}</td>
                                    <td>{{ item.quantidade }}</td>
                                    <td>R$ {{ item.preco_unitario }}</td>
                                    <td class="text-end pe-4 fw-bold text-dark">R$ {{ item.valor_total }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-3 text-muted">Nenhuma peça utilizada nesta OS.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="border-top">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Total em Peças:</td>
                                    <td class="text-end pe-4 fw-bold">R$ {{ ordem.total_pecas|floatformat:2 }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            {% if ordem.fotos.exists %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-secondary"><i class="bi bi-images"></i> Fotos Anexadas</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for foto in ordem.fotos.all %}
                        <div class="col-md-3 col-6">
                            <a href="{{ foto.imagem.url }}" target="_blank" class="text-decoration-none">
                                <div class="card h-100 border-0 shadow-sm">
                                    <img src="{{ foto.imagem.url }}" class="card-img-top rounded" style="height: 120px; object-fit: cover;" alt="Foto OS">
                                    {% if foto.descricao %}
                                    <div class="card-footer p-1 text-center small text-muted bg-white border-0">
                                        {{ foto.descricao }}
                                    </div>
                                    {% endif %}
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <div class="col-lg-4">
            
            <div class="card shadow mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Resumo Financeiro</h5>
                </div>
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-muted">Mão de Obra</span>
                        <span class="fw-bold">R$ {{ ordem.valor_mao_de_obra|floatformat:2 }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-muted">Peças</span>
                        <span class="fw-bold">R$ {{ ordem.total_pecas|floatformat:2 }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center bg-light">
                        <span class="text-danger">Desconto</span>
                        <span class="text-danger">- R$ {{ ordem.desconto|floatformat:2 }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center bg-success bg-opacity-10 py-3">
                        <span class="h5 mb-0 text-success">TOTAL</span>
                        <span class="h4 mb-0 text-success fw-bold">R$ {{ ordem.valor_total|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-person-circle"></i> Cliente</h5>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ ordem.cliente.nome }}</h5>
                    <p class="card-text mb-1"><i class="bi bi-telephone text-muted me-2"></i> {{ ordem.cliente.telefone_principal }}</p>
                    <p class="card-text mb-1"><i class="bi bi-envelope text-muted me-2"></i> {{ ordem.cliente.email|default:"Não informado" }}</p>
                    <p class="card-text"><i class="bi bi-geo-alt text-muted me-2"></i> {{ ordem.cliente.endereco|default:"Endereço não cadastrado" }}</p>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold text-muted">Informações Extras</h6>
                </div>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item">
                        <strong>Técnico:</strong> {{ ordem.tecnico.get_full_name|default:ordem.tecnico.username|default:"Não atribuído" }}
                    </li>
                    <li class="list-group-item">
                        <strong>Garantia:</strong> {{ ordem.garantia_dias }} dias
                    </li>
                    <li class="list-group-item">
                        <strong>Previsão:</strong> 
                        {% if ordem.data_previsao %}
                            {{ ordem.data_previsao|date:"d/m/Y" }}
                        {% else %}
                            Não informada
                        {% endif %}
                    </li>
                </ul>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-secondary"><i class="bi bi-clock-history"></i> Histórico</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for hist in ordem.historico.all %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-primary">{{ hist.get_novo_status_display }}</h6>
                                <small class="text-muted" style="font-size: 0.75rem;">{{ hist.data_alteracao|date:"d/m H:i" }}</small>
                            </div>
                            <p class="mb-1 small">{{ hist.observacao|default:"Alteração de status" }}</p>
                            <small class="text-muted" style="font-size: 0.75rem;">Por: {{ hist.usuario.get_full_name|default:hist.usuario.username }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    {% if ordem.observacoes_internas %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning bg-warning bg-opacity-10">
                <div class="card-body">
                    <h6 class="card-title text-warning-emphasis"><i class="bi bi-lock-fill"></i> Observações Internas (Não visível ao cliente)</h6>
                    <p class="card-text">{{ ordem.observacoes_internas|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}